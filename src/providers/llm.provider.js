const { askClaudeSonnet, ClaudeModel } = require("./anthropic.provider");
const { prompt } = require("inquirer");
const { setEnvVar, getEnvVar } = require("../utils/env.util");
const { askChatGpt4oMini, askOpenAiO1Mini, Gpt4oMiniModel, O1MiniModel } = require("./openai.provider");

const FullModelList = [
    ClaudeModel,
    Gpt4oMiniModel,
    // O1MiniModel // @todo figure out why this model is giving inconsistent results
];

/**
 * @function tryAskLLM
 * @param {string} componentType The type of prompt to send to AI (e.g. 'fc' or 'worker')
 * @description Tries to ask AI with a prompt to generate code
 * @returns {string} The code generated by AI or undefined if the user chose not to use AI
 */
async function tryAskLLM(componentType = 'fc') {
    // Prompt user if they want to give a description to claude
    let codeResult;

    let dftModelId = await getEnvVar('DEFAULT_MODEL_ID');

    console.log('\n')
    const { codePrompt } = await prompt([
        {
            type: 'input',
            name: 'codePrompt',
            message: `Prompt for generating code w/AI?\n (ignore and press ENTER to not use AI)\n`,
        },
    ]);
    if (codePrompt) {
        const _modelPrefFrequency = await getEnvVar('AI_MODEL_PREF_CHG_FREQ');
        if (!dftModelId || !_modelPrefFrequency || _modelPrefFrequency === 'EACH_TIME') {
            console.log('\n')
            const { aiProviderPref } = await prompt([
                {
                    type: 'list',
                    name: 'aiProviderPref',
                    message: `What AI model would you like to use?\n`,
                    default: dftModelId || ClaudeModel.value,
                    choices: FullModelList,
                }
            ]);
            dftModelId = aiProviderPref;
            await setEnvVar('DEFAULT_MODEL_ID', dftModelId);

            if (!dftModelId) {
                const { modelPrefFrequency } = await prompt([
                    {
                        type: 'list',
                        name: 'modelPrefFrequency',
                        message: `How often would you like select a specific model?\n`,
                        default: 'EACH_TIME',
                        choices: [
                            {
                                name: 'Ask for each command',
                                short: 'Ask each time',
                                value: 'EACH_TIME',
                            },
                            {
                                name: 'Always use this model',
                                short: 'Always this model',
                                value: 'ALWAYS',
                            },
                        ],
                    },
                ]);
                await setEnvVar('AI_MODEL_PREF_CHG_FREQ', modelPrefFrequency);
            }
        }
        
        const dftModel = FullModelList.find(m => m.value == dftModelId);
        if (!dftModel) {
            throw new Error(`Model with ID '${dftModelId || ''}' not found`);
        }
        try {
            switch (dftModel.value) {
                case Gpt4oMiniModel.value:
                    codeResult = await askChatGpt4oMini(codePrompt, componentType);
                    break;
                case O1MiniModel.value:
                    codeResult = await askOpenAiO1Mini(codePrompt, componentType);
                    break;
                case ClaudeModel.value:
                default:
                    codeResult = await askClaudeSonnet(codePrompt, componentType);
                    break;
            }
        } catch (error) {
            console.log('\n\n');
            throw new Error(error.message);
        }

        return codeResult;
    } else if (!codePrompt){
        console.log('\n');
        return;
    }
}



module.exports = { tryAskLLM };